name: Build and Release Web Client
on:
  push:
    tags:
      - 'v*'
jobs:
  build:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: windows-latest
            artifact_name: Marp-Web-Client-Windows.exe
            separator: ';'
            marp_pattern: '*win.zip'
            bin_path: 'bin/windows'
          - os: macos-latest
            artifact_name: Marp-Web-Client-macOS
            separator: ':'
            marp_pattern: '*mac.tar.gz'
            bin_path: 'bin/macos'
          - os: ubuntu-latest
            artifact_name: Marp-Web-Client-Linux
            separator: ':'
            marp_pattern: '*linux.tar.gz'
            bin_path: 'bin/linux'
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller playwright gradio
      - name: Download and Extract Marp CLI
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          mkdir -p ${{ matrix.bin_path }}
          gh release download -R marp-team/marp-cli -p "${{ matrix.marp_pattern }}"
          DOWNLOADED_FILE=$(ls ${{ matrix.marp_pattern }} | head -n 1)
          if [[ "$DOWNLOADED_FILE" == *.tar.gz ]]; then
            tar -xzf "$DOWNLOADED_FILE" -C ${{ matrix.bin_path }}
          elif [[ "$DOWNLOADED_FILE" == *.zip ]]; then
            unzip -o "$DOWNLOADED_FILE" -d ${{ matrix.bin_path }}
          fi
          rm "$DOWNLOADED_FILE"
      - name: Build with PyInstaller
        run: |
          pyinstaller --onefile --name ${{ matrix.artifact_name }} --add-data "bin${{ matrix.separator }}bin" --collect-all gradio web_app.py
      - name: Upload Artifact to Release
        uses: softprops/action-gh-release@v1
        with:
          files: dist/${{ matrix.artifact_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}